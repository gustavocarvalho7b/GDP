#!/bin/bash
set -e

# Remove o PID antigo para evitar erro no servidor
rm -f /rails/tmp/pids/server.pid

# Se o comando for iniciar o servidor Rails
if [ "$1" == "./bin/rails" ] && [ "$2" == "server" ]; then

  # Espera o banco de dados ficar disponível
  until pg_isready -h "$DATABASE_HOST" -p "$DATABASE_PORT" > /dev/null 2>&1; do
    echo "Aguardando banco de dados ficar disponível..."
    sleep 1
  done

  echo "Banco de dados disponível!"

  # Executa db:prepare (create + migrate)
  ./bin/rails db:prepare
fi

# Executa o comando do container
exec "$@"